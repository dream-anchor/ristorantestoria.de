name: Deploy Lovable SSG to IONOS (SFTP)

on:
  push:
    branches:
      - main
      - feature/static-site-upgrade

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: deploy-ionos
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Project (SSG)
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Copy .htaccess to dist
        run: cp public/.htaccess dist/.htaccess || echo "No .htaccess found"

      - name: Deploy via LFTP (parallel uploads)
        run: |
          sudo apt-get update && sudo apt-get install -y lftp
          lftp -c "
            set sftp:auto-confirm yes;
            set net:timeout 30;
            set net:max-retries 3;
            set net:reconnect-interval-base 5;
            set mirror:parallel-transfer-count 10;
            set mirror:parallel-directories yes;
            open -u ${{ secrets.IONOS_SFTP_USER }},${{ secrets.IONOS_SFTP_PASSWORD }} sftp://${{ secrets.IONOS_SFTP_HOST }};
            mirror --reverse --delete --verbose --parallel=10 ./dist/ ${{ secrets.IONOS_SFTP_TARGET_DIR }}/;
            quit;
          "
