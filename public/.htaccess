# Erzwinge UTF-8 für HTML-Dateien
AddDefaultCharset UTF-8

# ============================================
# 0. WICHTIGSTER FIX FÜR SSG (Ordner -> index.html)
# ============================================
# Das verhindert den 403 Fehler bei /en/ oder /menu/
# Sagt dem Server: "Wenn ein Ordner aufgerufen wird, zeig die index.html darin"
DirectoryIndex index.html

RewriteEngine On
RewriteBase /

# ============================================
# 1a. Subdomain Redirects (vor HTTPS/WWW, damit Pfad → Root)
# ============================================
# newsletter.ristorantestoria.de → www.ristorantestoria.de (immer Root)
RewriteCond %{HTTP_HOST} ^newsletter\.ristorantestoria\.de$ [NC]
RewriteRule ^ https://www.ristorantestoria.de/ [R=301,L]

# ============================================
# 1b. HTTPS + WWW Normalisierung (ein Hop statt zwei)
# ============================================
# Alle Varianten in einem 301-Hop auf https://www. normalisieren
# (http://ristorantestoria.de, https://ristorantestoria.de, http://www.ristorantestoria.de)
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteRule ^(.*)$ https://www.ristorantestoria.de/$1 [R=301,L]

# ============================================
# 1c. Trailing Slash erzwingen (SEO - URL Konsistenz)
# ============================================
# Fügt / am Ende hinzu (außer bei Dateien und Root)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !/$
RewriteCond %{REQUEST_URI} !\.[a-zA-Z0-9]+$
RewriteRule ^(.*)$ /$1/ [R=301,L]

# ============================================
# 1d. Multi-Language Slug Redirects (SEO - Translated URLs)
# ============================================
# Redirect German slugs on foreign language paths to localized slugs

# --- Valentinstag ---
RewriteRule ^en/special-occasions/valentinstag-menue/?$ /en/special-occasions/valentines-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/valentinstag-menue/?$ /it/occasioni-speciali/san-valentino-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/valentinstag-menue/?$ /fr/occasions-speciales/saint-valentin-menu/ [R=301,L]

# --- Weihnachten (neue permanente Slugs) ---
RewriteRule ^en/special-occasions/weihnachtsmenue/?$ /en/special-occasions/christmas-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/weihnachtsmenue/?$ /it/occasioni-speciali/natale-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/weihnachtsmenue/?$ /fr/occasions-speciales/noel-menu/ [R=301,L]

# --- Silvester (neue permanente Slugs) ---
RewriteRule ^en/special-occasions/silvester/?$ /en/special-occasions/new-years-eve/ [R=301,L]
RewriteRule ^it/occasioni-speciali/silvester/?$ /it/occasioni-speciali/capodanno/ [R=301,L]
RewriteRule ^fr/occasions-speciales/silvester/?$ /fr/occasions-speciales/nouvel-an/ [R=301,L]

# --- Ostern ---
RewriteRule ^en/special-occasions/ostern-menue/?$ /en/special-occasions/easter-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/ostern-menue/?$ /it/occasioni-speciali/pasqua-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/ostern-menue/?$ /fr/occasions-speciales/paques-menu/ [R=301,L]

# --- Muttertag ---
RewriteRule ^en/special-occasions/muttertag-menue/?$ /en/special-occasions/mothers-day-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/muttertag-menue/?$ /it/occasioni-speciali/festa-mamma-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/muttertag-menue/?$ /fr/occasions-speciales/fete-meres-menu/ [R=301,L]

# --- Vatertag ---
RewriteRule ^en/special-occasions/vatertag-menue/?$ /en/special-occasions/fathers-day-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/vatertag-menue/?$ /it/occasioni-speciali/festa-papa-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/vatertag-menue/?$ /fr/occasions-speciales/fete-peres-menu/ [R=301,L]

# --- Reservierung: DE Slug auf fremdsprachigen Pfaden → korrekte Übersetzung ---
RewriteRule ^en/reservierung/?$ /en/reservation/ [R=301,L]
RewriteRule ^it/reservierung/?$ /it/prenotazione/ [R=301,L]
RewriteRule ^fr/reservierung/?$ /fr/reservation/ [R=301,L]

# --- Abgelaufene/alte Seiten ---
RewriteRule ^en/besondere-anlaesse/winter-dinner-experience/?$ /en/special-occasions/ [R=301,L]

# ============================================
# 1d2. Alte Seasonal Slugs → Neue permanente Slugs (301)
# ============================================
# Weihnachten: Plural → Singular
RewriteRule ^besondere-anlaesse/weihnachtsmenues/?$ /besondere-anlaesse/weihnachtsmenue/ [R=301,L]
RewriteRule ^en/special-occasions/christmas-menus/?$ /en/special-occasions/christmas-menu/ [R=301,L]
RewriteRule ^en/special-occasions/weihnachtsmenues/?$ /en/special-occasions/christmas-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/weihnachtsmenues/?$ /it/occasioni-speciali/natale-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/noel-menus/?$ /fr/occasions-speciales/noel-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/weihnachtsmenues/?$ /fr/occasions-speciales/noel-menu/ [R=301,L]

# Silvester: -party → ohne
RewriteRule ^besondere-anlaesse/silvesterparty/?$ /besondere-anlaesse/silvester/ [R=301,L]
RewriteRule ^en/special-occasions/silvesterparty/?$ /en/special-occasions/new-years-eve/ [R=301,L]
RewriteRule ^en/special-occasions/new-years-party/?$ /en/special-occasions/new-years-eve/ [R=301,L]
RewriteRule ^it/occasioni-speciali/silvesterparty/?$ /it/occasioni-speciali/capodanno/ [R=301,L]
RewriteRule ^it/occasioni-speciali/capodanno-party/?$ /it/occasioni-speciali/capodanno/ [R=301,L]
RewriteRule ^fr/occasions-speciales/silvesterparty/?$ /fr/occasions-speciales/nouvel-an/ [R=301,L]
RewriteRule ^fr/occasions-speciales/nouvel-an-party/?$ /fr/occasions-speciales/nouvel-an/ [R=301,L]

# ============================================
# 1e. Legacy CMS Redirects (WordPress → Neue Seiten)
# ============================================
# Diese URLs existierten unter dem alten WordPress CMS (ristorantestoria.de/cms/...)
# 301-Redirects bewahren Link-Juice und verhindern 404s
RewriteRule ^cms/speisekarte/?$ /speisekarte/ [R=301,L]
RewriteRule ^cms/1753-2/?$ /kontakt/ [R=301,L]
RewriteRule ^cms/wp-content/uploads/2025/12/Mittagskarte-01\.12\.2025\.pdf$ /mittags-menu/ [R=301,L]
RewriteRule ^cms/wp-content/uploads/2025/03/Mittagskarte-Deutsch-25\.03\.2025-din\.pdf$ /mittags-menu/ [R=301,L]
RewriteRule ^cms/getraenke/?$ /getraenke/ [R=301,L]
RewriteRule ^cms/weihnachtsmenues-2/?$ /besondere-anlaesse/weihnachtsmenue/ [R=301,L]
RewriteRule ^cms/impressum/?$ /impressum/ [R=301,L]
RewriteRule ^cms/our-team/?$ /ueber-uns/ [R=301,L]
RewriteRule ^cms/reservations/?$ /reservierung/ [R=301,L]
RewriteRule ^cms/events(-2)?/?$ /besondere-anlaesse/ [R=301,L]
RewriteRule ^cms/catering/?$ /catering/ [R=301,L]
# Soft 404 Fixes
Redirect 301 /ristorantestoria-de/ https://www.ristorantestoria.de/
RedirectMatch 301 ^/cms/wp-content/uploads/.* https://www.ristorantestoria.de/mittags-menu/

# CMS Catch-All: Alle verbleibenden /cms/* Pfade → Startseite
RewriteRule ^cms/?$ / [R=301,L]
RewriteRule ^cms/(.+)$ / [R=301,L]

# ============================================
# 1f. Legacy URL Redirects (Alte Pfade → Aktuelle Struktur)
# ============================================
# Alte Top-Level-URLs die zur neuen URL-Architektur weiterleiten
RewriteRule ^mittagsmenu/?$ /mittags-menu/ [R=301,L]
RewriteRule ^weihnachtsmenues/?$ /besondere-anlaesse/weihnachtsmenue/ [R=301,L]
RewriteRule ^silvesterparty/?$ /besondere-anlaesse/silvester/ [R=301,L]
RewriteRule ^lunch-muenchen/?$ /lunch-muenchen-maxvorstadt/ [R=301,L]
RewriteRule ^eventlocation-muenchen/?$ /eventlocation-muenchen-maxvorstadt/ [R=301,L]
# Alte Subdomain-URL Struktur (ristorantestoria-de/...)
RewriteRule ^ristorantestoria-de/(.+)$ /$1 [R=301,L]
RewriteRule ^ristorantestoria-de/?$ / [R=301,L]

# ============================================
# 1h. /menu → /speisekarte (Thin Content entfernt)
# ============================================
RewriteRule ^menu/?$ /speisekarte/ [R=301,L]
RewriteRule ^en/menu/?$ /speisekarte/ [R=301,L]
RewriteRule ^it/menu/?$ /speisekarte/ [R=301,L]
RewriteRule ^fr/menu/?$ /speisekarte/ [R=301,L]

# ============================================
# 1i. Legal Pages — Nur DE (Fremdsprachen → 301 auf DE)
# ============================================
# Rechtliche Seiten existieren nur auf Deutsch.
# Alle fremdsprachigen URLs leiten auf die deutsche Version weiter.

# --- Impressum ---
RewriteRule ^en/imprint/?$ /impressum/ [R=301,L]
RewriteRule ^it/note-legali/?$ /impressum/ [R=301,L]
RewriteRule ^fr/mentions-legales/?$ /impressum/ [R=301,L]

# --- Datenschutz ---
RewriteRule ^en/privacy-policy/?$ /datenschutz/ [R=301,L]
RewriteRule ^it/privacy/?$ /datenschutz/ [R=301,L]
RewriteRule ^fr/confidentialite/?$ /datenschutz/ [R=301,L]

# --- Cookie-Richtlinie ---
RewriteRule ^en/cookie-policy/?$ /cookie-richtlinie/ [R=301,L]
RewriteRule ^it/cookie-policy/?$ /cookie-richtlinie/ [R=301,L]
RewriteRule ^fr/politique-cookies/?$ /cookie-richtlinie/ [R=301,L]

# --- AGB Restaurant ---
RewriteRule ^en/terms-restaurant/?$ /agb-restaurant/ [R=301,L]
RewriteRule ^it/termini-ristorante/?$ /agb-restaurant/ [R=301,L]
RewriteRule ^fr/cgv-restaurant/?$ /agb-restaurant/ [R=301,L]

# --- AGB Gutscheine ---
RewriteRule ^en/terms-vouchers/?$ /agb-gutscheine/ [R=301,L]
RewriteRule ^it/termini-buoni/?$ /agb-gutscheine/ [R=301,L]
RewriteRule ^fr/cgv-bons/?$ /agb-gutscheine/ [R=301,L]

# --- Widerrufsbelehrung ---
RewriteRule ^en/cancellation-policy/?$ /widerrufsbelehrung/ [R=301,L]
RewriteRule ^it/diritto-recesso/?$ /widerrufsbelehrung/ [R=301,L]
RewriteRule ^fr/droit-retractation/?$ /widerrufsbelehrung/ [R=301,L]

# --- Zahlungsinformationen ---
RewriteRule ^en/payment-info/?$ /zahlungsinformationen/ [R=301,L]
RewriteRule ^it/info-pagamento/?$ /zahlungsinformationen/ [R=301,L]
RewriteRule ^fr/infos-paiement/?$ /zahlungsinformationen/ [R=301,L]

# --- Lebensmittelhinweise ---
RewriteRule ^en/food-info/?$ /lebensmittelhinweise/ [R=301,L]
RewriteRule ^it/info-alimenti/?$ /lebensmittelhinweise/ [R=301,L]
RewriteRule ^fr/infos-alimentaires/?$ /lebensmittelhinweise/ [R=301,L]

# --- Haftungsausschluss ---
RewriteRule ^en/disclaimer/?$ /haftungsausschluss/ [R=301,L]
RewriteRule ^it/disclaimer/?$ /haftungsausschluss/ [R=301,L]
RewriteRule ^fr/avertissement/?$ /haftungsausschluss/ [R=301,L]

# ============================================
# 1g. WordPress Query-String Redirect
# ============================================
RewriteCond %{QUERY_STRING} ^page_id=2881$
RewriteRule ^$ /impressum/? [R=301,L]

# ============================================
# 2. Error Documents (Fallback auf SPA)
# ============================================
ErrorDocument 404 /index.html
ErrorDocument 500 /index.html

# ============================================
# 3. SPA-Routing & SSG Support
# ============================================
# A) Existierende Datei? -> Direkt ausliefern!
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# B) Existierender Ordner? -> Direkt ausliefern!
# Durch 'DirectoryIndex' oben wird hier nun die index.html im Ordner geladen
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# C) Alles andere (virtuelle Routen) -> SPA Fallback (Startseite)
RewriteRule ^ index.html [L]

# ============================================
# 4. MIME-Types für korrekte Dateiauslieferung
# ============================================
<IfModule mod_mime.c>
  AddType application/javascript .js
  AddType text/css .css
  AddType image/webp .webp
  AddType image/svg+xml .svg
  AddType font/woff2 .woff2
  AddType application/xml .xml
  AddType text/plain .txt
</IfModule>

# ============================================
# 5. GZIP-Komprimierung
# ============================================
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json image/svg+xml
</IfModule>

# ============================================
# 6. Browser-Caching
# ============================================
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# ============================================
# 7. Sitemap - Force XML Content-Type
# ============================================
<Files "sitemap.xml">
  ForceType application/xml
  <IfModule mod_headers.c>
    Header set Content-Type "application/xml; charset=UTF-8"
    Header set X-Content-Type-Options "nosniff"
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </IfModule>
</Files>

# Ensure all XML files use UTF-8
AddCharset UTF-8 .xml
