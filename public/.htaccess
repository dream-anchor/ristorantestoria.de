# Erzwinge UTF-8 für HTML-Dateien
AddDefaultCharset UTF-8

# ============================================
# 0. WICHTIGSTER FIX FÜR SSG (Ordner -> index.html)
# ============================================
# Das verhindert den 403 Fehler bei /en/ oder /menu/
# Sagt dem Server: "Wenn ein Ordner aufgerufen wird, zeig die index.html darin"
DirectoryIndex index.html

RewriteEngine On
RewriteBase /

# ============================================
# 1. HTTPS Erzwingen (Sicherheit & SEO)
# ============================================
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ============================================
# 1b. WWW Normalisierung (SEO - Domain Authority)
# ============================================
# Redirect non-www zu www (kanonische Domain)
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteRule ^ https://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# ============================================
# 1c. Trailing Slash erzwingen (SEO - URL Konsistenz)
# ============================================
# Fügt / am Ende hinzu (außer bei Dateien und Root)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !/$
RewriteCond %{REQUEST_URI} !\.[a-zA-Z0-9]+$
RewriteRule ^(.*)$ /$1/ [R=301,L]

# ============================================
# 1d. Multi-Language Slug Redirects (SEO - Translated URLs)
# ============================================
# Redirect German slugs on foreign language paths to localized slugs

# --- Valentinstag ---
RewriteRule ^en/special-occasions/valentinstag-menue/?$ /en/special-occasions/valentines-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/valentinstag-menue/?$ /it/occasioni-speciali/san-valentino-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/valentinstag-menue/?$ /fr/occasions-speciales/saint-valentin-menu/ [R=301,L]

# --- Weihnachten ---
RewriteRule ^en/special-occasions/weihnachtsmenues/?$ /en/special-occasions/christmas-menus/ [R=301,L]
RewriteRule ^it/occasioni-speciali/weihnachtsmenues/?$ /it/occasioni-speciali/natale-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/weihnachtsmenues/?$ /fr/occasions-speciales/noel-menus/ [R=301,L]

# --- Silvester ---
RewriteRule ^en/special-occasions/silvesterparty/?$ /en/special-occasions/new-years-party/ [R=301,L]
RewriteRule ^it/occasioni-speciali/silvesterparty/?$ /it/occasioni-speciali/capodanno-party/ [R=301,L]
RewriteRule ^fr/occasions-speciales/silvesterparty/?$ /fr/occasions-speciales/nouvel-an-party/ [R=301,L]

# --- Ostern ---
RewriteRule ^en/special-occasions/ostern-menue/?$ /en/special-occasions/easter-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/ostern-menue/?$ /it/occasioni-speciali/pasqua-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/ostern-menue/?$ /fr/occasions-speciales/paques-menu/ [R=301,L]

# --- Muttertag ---
RewriteRule ^en/special-occasions/muttertag-menue/?$ /en/special-occasions/mothers-day-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/muttertag-menue/?$ /it/occasioni-speciali/festa-mamma-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/muttertag-menue/?$ /fr/occasions-speciales/fete-meres-menu/ [R=301,L]

# --- Vatertag ---
RewriteRule ^en/special-occasions/vatertag-menue/?$ /en/special-occasions/fathers-day-menu/ [R=301,L]
RewriteRule ^it/occasioni-speciali/vatertag-menue/?$ /it/occasioni-speciali/festa-papa-menu/ [R=301,L]
RewriteRule ^fr/occasions-speciales/vatertag-menue/?$ /fr/occasions-speciales/fete-peres-menu/ [R=301,L]

# --- Legacy CMS Redirects ---
RewriteRule ^cms/speisekarte/?$ /speisekarte/ [R=301,L]

# ============================================
# 2. Error Documents (Fallback auf SPA)
# ============================================
ErrorDocument 404 /index.html
ErrorDocument 500 /index.html

# ============================================
# 3. SPA-Routing & SSG Support
# ============================================
# A) Existierende Datei? -> Direkt ausliefern!
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# B) Existierender Ordner? -> Direkt ausliefern!
# Durch 'DirectoryIndex' oben wird hier nun die index.html im Ordner geladen
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# C) Alles andere (virtuelle Routen) -> SPA Fallback (Startseite)
RewriteRule ^ index.html [L]

# ============================================
# 4. MIME-Types für korrekte Dateiauslieferung
# ============================================
<IfModule mod_mime.c>
  AddType application/javascript .js
  AddType text/css .css
  AddType image/webp .webp
  AddType image/svg+xml .svg
  AddType font/woff2 .woff2
  AddType application/xml .xml
  AddType text/plain .txt
</IfModule>

# ============================================
# 5. GZIP-Komprimierung
# ============================================
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json image/svg+xml
</IfModule>

# ============================================
# 6. Browser-Caching
# ============================================
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# ============================================
# 7. Sitemap - Force XML Content-Type
# ============================================
<Files "sitemap.xml">
  ForceType application/xml
  <IfModule mod_headers.c>
    Header set Content-Type "application/xml; charset=UTF-8"
    Header set X-Content-Type-Options "nosniff"
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </IfModule>
</Files>

# Ensure all XML files use UTF-8
AddCharset UTF-8 .xml
